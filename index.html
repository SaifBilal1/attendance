<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ุชุณุฌูู ุงูุฏูุงู</title>
</head>

<body style="font-family:Arial;text-align:center;padding:20px">

<h2>ุชุณุฌูู ุงูุฏุฎูู / ุงูุฎุฑูุฌ</h2>

<select id="name" style="width:90%;padding:12px">
  <option value="">โณ ุฌุงุฑู ุชุญููู ุงูุฃุณูุงุก...</option>
</select>
<br><br>

<select id="type" style="width:90%;padding:12px">
  <option value="ุฏุฎูู">ุฏุฎูู</option>
  <option value="ุฎุฑูุฌ">ุฎุฑูุฌ</option>
</select><br><br>

<button onclick="start()" style="padding:15px;width:90%">ุชุณุฌูู</button>

<p id="status"></p>

<script>
// ===== ุฑุงุจุท Google Apps Script (ุงูุฌุฏูุฏ) =====
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzpu1ZH9XM9qR9-bWep1YyYBikfXA3YcaPsfkiZpwSgd_Ul_S3xruaecEUAcR50TtHHkA/exec";

// ===== ุฅุนุฏุงุฏุงุช ูููุน ุงูุฏูุงู =====
const OFFICE_LAT = 36.234905532743525;
const OFFICE_LNG = 43.99674391239932;
const ALLOWED_RADIUS = 300; // ูุชุฑ

// ===== ุชุญููู ุงูุฃุณูุงุก ูู Google Sheet =====
fetch(SCRIPT_URL)
  .then(res => res.json())
  .then(names => {
    const select = document.getElementById("name");
    select.innerHTML = '<option value="">-- ุงุฎุชุฑ ุงุณูู --</option>';
    names.forEach(n => {
      const opt = document.createElement("option");
      opt.value = n;
      opt.textContent = n;
      select.appendChild(opt);
    });
  })
  .catch(() => {
    document.getElementById("name").innerHTML =
      '<option value="">โ ูุดู ุชุญููู ุงูุฃุณูุงุก</option>';
  });

// ===== ุฏุงูุฉ ุญุณุงุจ ุงููุณุงูุฉ =====
function distance(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a =
    Math.sin(dLat / 2) ** 2 +
    Math.cos(lat1 * Math.PI / 180) *
    Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon / 2) ** 2;
  return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

// ===== ุชุณุฌูู ุงูุฏุฎูู / ุงูุฎุฑูุฌ =====
function start() {
  if (!document.getElementById("name").value) {
    document.getElementById("status").innerText = "โ๏ธ ูุฑุฌู ุงุฎุชูุงุฑ ุงูุงุณู";
    return;
  }

  document.getElementById("status").innerText = "๐ ุฌุงุฑู ุชุญุฏูุฏ ุงููููุน...";

  navigator.geolocation.getCurrentPosition(
    pos => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      const acc = pos.coords.accuracy;

      if (acc > 200) {
        document.getElementById("status").innerText =
          "๐ก ุฅุดุงุฑุฉ GPS ุถุนููุฉุ ุงูุชุธุฑ ููููุงู";
        return;
      }

      if (distance(lat, lng, OFFICE_LAT, OFFICE_LNG) > ALLOWED_RADIUS) {
        document.getElementById("status").innerText = "๐จ ุฎุงุฑุฌ ูุทุงู ุงููููุน";
        return;
      }

      fetch(SCRIPT_URL, {
        method: "POST",
        headers: {
          "Content-Type": "text/plain;charset=utf-8"
        },
        body: JSON.stringify({
          name: document.getElementById("name").value,
          type: document.getElementById("type").value,
          lat: lat,
          lng: lng,
          accuracy: acc
        })
      })
      .then(() => {
        document.getElementById("status").innerText = "โ ุชู ุงูุชุณุฌูู ุจูุฌุงุญ";
      })
      .catch(() => {
        document.getElementById("status").innerText = "โ ุฎุทุฃ ูู ุงูุฅุฑุณุงู";
      });
    },
    () => {
      document.getElementById("status").innerText =
        "โ ูู ูุชู ุงูุญุตูู ุนูู ุงููููุนุ ูุนูู GPS";
    },
    {
      enableHighAccuracy: true,
      timeout: 15000,
      maximumAge: 0
    }
  );
}
</script>

</body>
</html>
