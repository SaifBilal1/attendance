<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨ØµÙ…Ø©</title>
</head>

<body style="font-family:Arial;text-align:center;padding:20px">

<h2>Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ§Ù…</h2>

<!-- ===== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ===== -->
<div id="loginBox">
  <input id="username" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" style="width:90%;padding:12px"><br><br>
  <input id="password" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" style="width:90%;padding:12px"><br><br>
  <button onclick="login()" style="padding:15px;width:90%">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
  <p id="loginStatus"></p>
</div>

<!-- ===== Ø§Ù„Ø¨ØµÙ…Ø© ===== -->
<div id="attendanceBox" style="display:none">

  <h3 id="welcome"></h3>

  <select id="type" style="width:90%;padding:12px">
    <option value="Ø¯Ø®ÙˆÙ„">Ø¯Ø®ÙˆÙ„</option>
    <option value="Ø®Ø±ÙˆØ¬">Ø®Ø±ÙˆØ¬</option>
  </select><br><br>

  <button onclick="startAttendance()" style="padding:15px;width:90%">
    ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨ØµÙ…Ø©
  </button>

  <p id="status"></p>

  <button onclick="logout()" style="margin-top:20px;width:90%">
    ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
  </button>
</div>

<script>
/* =================================================
   Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø©
================================================= */
const SCRIPT_URL =
"https://script.google.com/macros/s/AKfycbxFpFg5Rh8LxrWxB7H9ZFFRGnv0TkjA0DNj3B7UFbfoexozKCdiADVuaT8rXhBBvIMnMA/exec";

/* ===== Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¯ÙˆØ§Ù… ===== */
const OFFICE_LAT = 36.234905532743525;
const OFFICE_LNG = 43.99674391239932;
const ALLOWED_RADIUS = 300; // Ù…ØªØ±

/* =================================================
   Device ID (Ù‡Ø§ØªÙ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·)
================================================= */
function getDeviceId() {
  let id = localStorage.getItem("device_id");
  if (!id) {
    id = crypto.randomUUID();
    localStorage.setItem("device_id", id);
  }
  return id;
}

/* =================================================
   Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©
================================================= */
function distance(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a =
    Math.sin(dLat / 2) ** 2 +
    Math.cos(lat1 * Math.PI / 180) *
    Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon / 2) ** 2;
  return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

/* =================================================
   ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
================================================= */
function login() {
  document.getElementById("loginStatus").innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...";

  fetch(SCRIPT_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify({
      action: "login",
      username: document.getElementById("username").value,
      password: document.getElementById("password").value,
      deviceId: getDeviceId()
    })
  })
  .then(r => r.json())
  .then(res => {
    if (res.status === "ok") {
      localStorage.setItem("employeeName", res.name);
      document.getElementById("loginBox").style.display = "none";
      document.getElementById("attendanceBox").style.display = "block";
      document.getElementById("welcome").innerText =
        "Ù…Ø±Ø­Ø¨Ø§Ù‹ " + res.name;
    } else {
      document.getElementById("loginStatus").innerText =
        "âŒ " + res.message;
    }
  })
  .catch(() => {
    document.getElementById("loginStatus").innerText =
      "âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„";
  });
}

/* =================================================
   ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨ØµÙ…Ø©
================================================= */
function startAttendance() {
  document.getElementById("status").innerText =
    "ğŸ“ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...";

  navigator.geolocation.getCurrentPosition(
    pos => {
      const d = distance(
        pos.coords.latitude,
        pos.coords.longitude,
        OFFICE_LAT,
        OFFICE_LNG
      );

      if (d > ALLOWED_RADIUS) {
        document.getElementById("status").innerText =
          "ğŸš¨ Ø®Ø§Ø±Ø¬ Ù†Ø·Ø§Ù‚ Ø§Ù„Ù…ÙˆÙ‚Ø¹";
        return;
      }

      fetch(SCRIPT_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({
          action: "attendance",
          name: localStorage.getItem("employeeName"),
          type: document.getElementById("type").value,
          lat: pos.coords.latitude,
          lng: pos.coords.longitude,
          accuracy: pos.coords.accuracy
        })
      })
      .then(r => r.json())
      .then(res => {
        document.getElementById("status").innerText =
          res.status === "ok"
            ? "âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­"
            : "âŒ " + res.message;
      });
    },
    () => {
      document.getElementById("status").innerText =
        "âŒ ÙØ¹Ù‘Ù„ GPS";
    },
    { enableHighAccuracy: true, timeout: 15000 }
  );
}

/* =================================================
   ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…
================================================= */
function logout() {
  localStorage.removeItem("employeeName");
  document.getElementById("attendanceBox").style.display = "none";
  document.getElementById("loginBox").style.display = "block";
}
</script>

</body>
</html>
